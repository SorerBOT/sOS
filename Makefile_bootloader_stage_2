ARCH = i386

BOOTLOADER_DIR = bootloader
ARCH_DIR = arch
LIBC_DIR = $(BOOTLOADER_DIR)/libc_partials
DRIVERS_DIR = drivers
STAGE_2_DIR = $(BOOTLOADER_DIR)/stage_2
BIN_DIR = bin
BIN_32_BIT_DIR = $(BIN_DIR)/32-bit
BIN_32_BIT_ASM_DIR=$(BIN_32_BIT_DIR)/asm


STAGE_2 = $(STAGE_2_DIR)/bootloader_stage_2

STAGE_2_ORG=0x7E00

STAGE_2_SRCS := $(shell find $(STAGE_2_DIR) -type f \( -name '*.c' -o -name '*.asm' \))
ARCH_SRCS := $(shell find $(ARCH_DIR)/$(ARCH) -type f \( -name '*.c' -o -name '*.asm' \))
DRIVERS_ARCH_SRCS := $(shell find $(DRIVERS_DIR)/$(ARCH) -type f \( -name '*.c' -o -name '*.asm' \))
LIBC_PARTIALS_SRCS := $(shell find $(LIBC_DIR) -type f \( -name '*.c' -o -name '*.asm' \))

ALL_SRCS = $(STAGE_2_SRCS) $(ARCH_SRCS) $(DRIVERS_ARCH_SRCS) $(LIBC_PARTIALS_SRCS)
C_OBJS := $(patsubst %.c, $(BIN_32_BIT_DIR)/%.o, $(filter %.c, $(ALL_SRCS)))
ASM_OBJS := $(patsubst %.asm, $(BIN_32_BIT_ASM_DIR)/%.o, $(filter %.asm, $(ALL_SRCS)))
ALL_OBJS := $(ASM_OBJS) $(C_OBJS)
START_OBJ := $(BIN_32_BIT_ASM_DIR)/$(STAGE_2).o
ALL_OBJS_EXCEPT_START := $(filter-out $(START_OBJ), $(ALL_OBJS))

INCLUDE_FLAGS = -Ibootloader/ -Idrivers/$(ARCH)/include -Iarch/$(ARCH)/include -Iarch/common/include
CFLAGS = -std=c99 -ffreestanding -m32 -g $(INCLUDE_FLAGS)

$(BIN_32_BIT_DIR)/$(STAGE_2).bin: $(ALL_OBJS)
	@echo "Linking stage 2..."
	@mkdir -p $(dir $@)
	x86_64-elf-ld -m elf_i386 --oformat binary -Ttext $(STAGE_2_ORG) \
		-o $@ \
		$(START_OBJ) $(ALL_OBJS_EXCEPT_START)

$(BIN_32_BIT_DIR)/%.o: %.c
	@echo "Compiling C file $<"
	@mkdir -p $(dir $@)
	x86_64-elf-gcc $(CFLAGS) -c $< -o $@

$(BIN_32_BIT_ASM_DIR)/%.o: %.asm
	@echo "Compiling ASM file $<"
	@mkdir -p $(dir $@)
	nasm -f elf32 $< -o $@

clean:
	rm -rf $(BIN_32_BIT_DIR)
